<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComTrack</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- XLSX for Excel handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        /* Custom scrollbar for better visibility */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- TYPES & CONSTANTS ---

        const COLUMN_MAPPING = {
            "A": "No", "B": "SalesOrderDeliveryCode", "C": "Customer PO Reference", "D": "SO Del. Qty",
            "E": "Cancelled Qty", "F": "Net SO Del. Qty", "G": "Unit Price", "H": "Net Value",
            "I": "SO Status", "J": "SOL Status", "K": "Production Order", "L": "Sales Document",
            "M": "SalesDocStatus", "N": "Picking List", "O": "Picking Status", "P": "Invoice Num",
            "Q": "Customer Code", "R": "Customer", "S": "Brand", "T": "Sub Brand",
            "U": "Sub Brand Name", "V": "Customer Material Code", "W": "Item Code", "X": "Sub Code 01",
            "Y": "Sub Code 02", "Z": "Sub Code 03", "AA": "Sub Code 04", "AB": "Sub Code 05",
            "AC": "Sub Code 06", "AD": "Sub Code 07", "AE": "Sub Code 08", "AF": "Sub Code 09",
            "AG": "Sub Code 10", "AH": "Color", "AI": "Color Description", "AJ": "FG Transit Qty",
            "AK": "FG Transit Qty (A)", "AL": "FG Transit Qty (P)", "AM": "FG Ready Qty",
            "AN": "FG Ready Qty (A)", "AO": "FG Ready Qty (P)", "AP": "FG Ready (P|CLR)",
            "AQ": "FG Ready (P|QA)", "AR": "FG Ready (P|INS)", "AS": "FG Ready (P|REJ)",
            "AT": "Picking Pending Qty", "AU": "Shipping Pending Qty", "AV": "Invoice Pending Qty",
            "AW": "Dispatch Pending Qty", "AX": "P&R Qty", "AY": "P&R Sec. Qty", "AZ": "P&R Gross Qty",
            "BA": "P&R Ele. Count", "BB": "P&R Con.Ele. Count", "BC": "Prod. Conf. Date",
            "BD": "SO Conf. Date", "BE": "Shipped Date", "BF": "Invoice Date",
            "BG": "Delivery Address", "BH": "Order - Status", "BI": "Week Status", "BJ": "Remarks",
            "BK": "FG Ready Age (D)", "BL": "FG Ageing Status", "BM": "Portal Response",
            "BN": "Portal Response Date"
        };

        const COLUMN_KEYS = Object.values(COLUMN_MAPPING);

        // --- USER DEFINED COLUMN CONFIGURATION ---
        // Based on the request for "more visibility"
        const USER_COLUMN_CONFIG = {
            "No": { align: "text-center", width: "auto" },
            "SalesOrderDeliveryCode": { align: "text-center", width: "auto" },
            "Customer PO Reference": { align: "text-center", width: "160px" },
            "SO Del. Qty": { align: "text-right" },
            "Cancelled Qty": { align: "text-right" },
            "Net SO Del. Qty": { align: "text-right" },
            "Unit Price": { align: "text-right" },
            "Net Value": { align: "text-right" },
            "SO Status": { align: "text-center" },
            "SOL Status": { align: "text-center" },
            "Production Order": { align: "text-center" },
            "Sales Document": { align: "text-center", width: "auto" }, 
            "SalesDocStatus": { align: "text-center" },
            "Picking List": { align: "text-center" },
            "Picking Status": { align: "text-center" },
            "Invoice Num": { align: "text-center" },
            "Customer Code": { align: "text-center" },
            "Customer": { align: "text-center" },
            "Brand": { align: "text-center" },
            "Sub Brand": { align: "text-center" },
            "Sub Brand Name": { align: "text-center" },
            "Customer Material Code": { align: "text-center" },
            "Item Code": { align: "text-left", width: "500px" },
            "Sub Code 01": { align: "text-center" },
            "Sub Code 02": { align: "text-center" },
            "Sub Code 03": { align: "text-center" },
            "Sub Code 04": { align: "text-center" },
            "Sub Code 05": { align: "text-center" },
            "Sub Code 06": { align: "text-center" },
            "Sub Code 07": { align: "text-center" },
            "Sub Code 08": { align: "text-center" },
            "Sub Code 09": { align: "text-center" },
            "Sub Code 10": { align: "text-center" },
            "Color": { align: "text-center" },
            "Color Description": { align: "text-left", width: "300px" },
            "FG Transit Qty": { align: "text-right" },
            "FG Transit Qty (A)": { align: "text-right" },
            "FG Transit Qty (P)": { align: "text-right" },
            "FG Ready Qty": { align: "text-right" },
            "FG Ready Qty (A)": { align: "text-right" },
            "FG Ready Qty (P)": { align: "text-right" },
            "FG Ready (P|CLR)": { align: "text-right" },
            "FG Ready (P|QA)": { align: "text-right" },
            "FG Ready (P|INS)": { align: "text-right" },
            "FG Ready (P|REJ)": { align: "text-right" },
            "Picking Pending Qty": { align: "text-right" },
            "Shipping Pending Qty": { align: "text-right" },
            "Invoice Pending Qty": { align: "text-right" },
            "Dispatch Pending Qty": { align: "text-right" },
            "P&R Qty": { align: "text-right" },
            "P&R Sec. Qty": { align: "text-right" },
            "P&R Gross Qty": { align: "text-right" },
            "P&R Ele. Count": { align: "text-center" },
            "P&R Con.Ele. Count": { align: "text-center" },
            "Prod. Conf. Date": { align: "text-center" },
            "SO Conf. Date": { align: "text-center" },
            "Shipped Date": { align: "text-center" },
            "Invoice Date": { align: "text-center" },
            "Delivery Address": { align: "text-left", width: "700px" },
            "Order - Status": { align: "text-center" },
            "Week Status": { align: "text-center" },
            "Remarks": { align: "text-left", width: "300px" },
            "FG Ready Age (D)": { align: "text-center" },
            "FG Ageing Status": { align: "text-center" },
            "Portal Response": { align: "text-left", width: "1200px" },
            "Portal Response Date": { align: "text-center" }
        };

        const Icons = {
            Upload: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 3 3m-3-3v15" />
                </svg>
            ),
            Download: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
            ),
            Search: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                </svg>
            ),
            FileText: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                </svg>
            ),
            XMark: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
            ),
            Filter: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 0 1-.659 1.591l-5.432 5.432a2.25 2.25 0 0 0-.659 1.591v2.927a2.25 2.25 0 0 1-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 0 0-.659-1.591L3.659 7.409A2.25 2.25 0 0 1 3 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0 1 12 3Z" />
                </svg>
            ),
            Table: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125V5.625c0-.621.504-1.125 1.125-1.125h17.25c.621 0 1.125.504 1.125 1.125v12.75c0 .621-.504 1.125-1.125 1.125m-17.25 0V5.625m17.25 0v12.75M6.75 7.5v.008H6.75V7.5Zm0 3v.008H6.75v-.008Zm0 3v.008H6.75v-.008Zm3-6v.008h-.008V7.5Zm0 3v.008h-.008v-.008Zm0 3v.008h-.008v-.008Zm3-6v.008h-.008V7.5Zm0 3v.008h-.008v-.008Zm0 3v.008h-.008v-.008Zm3-6v.008h-.008V7.5Zm0 3v.008h-.008v-.008Zm0 3v.008h-.008v-.008Zm3-6v.008h-.008V7.5Zm0 3v.008h-.008v-.008Zm0 3v.008h-.008v-.008Z" />
                </svg>
            ),
            ClipboardList: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 18 4.5h-2.25a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 15.75 18.75Zm-2.25-12a2.25 2.25 0 0 0-2.25-2.25h-3a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 6 18.75h2.25" />
                </svg>
            )
        };

        // --- COMPONENTS ---

        const DataUpload = ({ onUpload, loading }) => {
            const [dragActive, setDragActive] = React.useState(false);

            const handleDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setDragActive(true);
                } else if (e.type === "dragleave") {
                    setDragActive(false);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    onUpload(e.dataTransfer.files[0]);
                }
            };

            const handleChange = (e) => {
                e.preventDefault();
                if (e.target.files && e.target.files[0]) {
                    onUpload(e.target.files[0]);
                }
            };

            return (
                <div className="max-w-xl w-full">
                    <div 
                        className={`relative bg-white border-2 border-dashed rounded-2xl p-12 text-center transition-all ${
                            dragActive ? "border-blue-500 bg-blue-50" : "border-slate-200 hover:border-blue-400"
                        }`}
                        onDragEnter={handleDrag}
                        onDragLeave={handleDrag}
                        onDragOver={handleDrag}
                        onDrop={handleDrop}
                    >
                        <input 
                            type="file" 
                            id="file-upload" 
                            className="hidden" 
                            accept=".xlsx, .xls, .csv" 
                            onChange={handleChange}
                            disabled={loading}
                        />
                        <label htmlFor="file-upload" className="cursor-pointer">
                            <div className="bg-blue-100 text-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                                {loading ? (
                                    <svg className="animate-spin h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                ) : (
                                    <Icons.Upload className="w-8 h-8" />
                                )}
                            </div>
                            <h3 className="text-xl font-bold text-slate-800 mb-2">
                                {loading ? "Processing Data..." : "Upload Data Sheet"}
                            </h3>
                            <p className="text-slate-500 mb-8 max-w-sm mx-auto">
                                {loading 
                                    ? "We're parsing your file and preparing the preview. This may take a moment for larger datasets."
                                    : "Drag and drop your Excel (.xlsx) or CSV file here to begin the analysis."
                                }
                            </p>
                            {!loading && (
                                <div className="inline-flex px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors shadow-lg shadow-blue-200">
                                    Select File
                                </div>
                            )}
                        </label>
                        
                        <div className="mt-8 pt-8 border-t border-slate-100 grid grid-cols-2 gap-4">
                            <div className="flex items-start gap-3 text-left">
                                <div className="bg-slate-100 p-2 rounded-lg mt-1">
                                    <Icons.FileText className="w-4 h-4 text-slate-500" />
                                </div>
                                <div>
                                    <p className="text-xs font-bold text-slate-700">66 Columns Supported</p>
                                    <p className="text-[10px] text-slate-400 leading-tight">Full range from Sales Orders to Portal Responses</p>
                                </div>
                            </div>
                            <div className="flex items-start gap-3 text-left">
                                <div className="bg-slate-100 p-2 rounded-lg mt-1">
                                    <Icons.Search className="w-4 h-4 text-slate-500" />
                                </div>
                                <div>
                                    <p className="text-xs font-bold text-slate-700">Smart Search</p>
                                    <p className="text-[10px] text-slate-400 leading-tight">Filter by SO, PO, Document, or Brands instantly</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p className="text-center mt-6 text-sm text-slate-400">
                        Supported formats: .xlsx, .xls, .csv (Max 10MB recommended)
                    </p>
                </div>
            );
        };

        const DataTable = ({ rows, columnSettings }) => {
            const [sortConfig, setSortConfig] = React.useState({ key: '', direction: null });
            const [headerFilters, setHeaderFilters] = React.useState({});

            const visibleKeys = COLUMN_KEYS.filter(key => !columnSettings || columnSettings[key]?.visible !== false);

            const handleSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key) {
                    if (sortConfig.direction === 'asc') direction = 'desc';
                    else if (sortConfig.direction === 'desc') direction = null;
                }
                setSortConfig({ key: direction ? key : '', direction });
            };

            const handleFilterChange = (key, value) => {
                setHeaderFilters(prev => ({ ...prev, [key]: value }));
            };

            const filteredAndSortedRows = React.useMemo(() => {
                let result = [...rows];

                Object.keys(headerFilters).forEach(key => {
                    const filterVal = headerFilters[key].toLowerCase();
                    if (filterVal) {
                        result = result.filter(row => 
                            String(row[key] || "").toLowerCase().includes(filterVal)
                        );
                    }
                });

                if (sortConfig.key && sortConfig.direction) {
                    result.sort((a, b) => {
                        const valA = a[sortConfig.key];
                        const valB = b[sortConfig.key];

                        if (valA === valB) return 0;
                        if (valA == null) return 1;
                        if (valB == null) return -1;

                        if (typeof valA === 'number' && typeof valB === 'number') {
                            return sortConfig.direction === 'asc' ? valA - valB : valB - valA;
                        }

                        const strA = String(valA).toLowerCase();
                        const strB = String(valB).toLowerCase();
                        return sortConfig.direction === 'asc' 
                            ? strA.localeCompare(strB) 
                            : strB.localeCompare(strA);
                    });
                }

                return result;
            }, [rows, sortConfig, headerFilters]);

            const getColStyle = (key) => {
                const setting = columnSettings?.[key];
                const align = setting?.align || 'text-center';
                let width = setting?.width === 'auto' ? 'auto' : (setting?.width || '160px');
                
                if (key === "No") width = '60px';
                if (key === "SalesOrderDeliveryCode") width = '280px';

                return { align, width };
            };

            const formatValue = (key, value) => {
                if (value == null || value === "") return '-';
                const numericCols = ["SO Del. Qty", "Net Value", "FG Transit Qty", "FG Ready Qty (A)", "FG Ready Qty (P)"];
                if (numericCols.includes(key) && typeof value === 'number') {
                    return new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
                }
                return String(value);
            };

            const getCellClass = (key, value) => {
                const { align } = getColStyle(key);
                let base = `px-3 md:px-4 py-2 md:py-3 text-[10px] md:text-[11px] border-r border-slate-100 last:border-0 ${align} whitespace-nowrap transition-colors `;
                
                if (key === "No") {
                    base += "font-bold text-slate-400 bg-white sticky left-0 z-20 border-r-2 border-slate-200 ";
                }
                if (key === "SalesOrderDeliveryCode") {
                    base += "font-bold text-blue-600 bg-white sticky z-20 border-r-2 border-slate-200 ";
                }
                
                let colorClass = "text-slate-700";
                if (typeof value === 'number' && value > 0) {
                    if (key === "FG Ready Qty (A)") colorClass = "text-green-800 bg-green-50 font-bold";
                    else if (key === "FG Transit Qty") colorClass = "text-orange-800 bg-orange-50 font-bold";
                    else if (key === "FG Ready Qty (P)") colorClass = "text-red-800 bg-red-50 font-bold";
                    else colorClass = "text-slate-800 font-mono";
                }
                if (key === "SalesOrderDeliveryCode") colorClass = "text-blue-600 font-bold";
                
                return `${base} ${colorClass}`;
            };

            if (rows.length === 0) {
                return (
                    <div className="py-20 text-center">
                        <p className="text-slate-400 font-bold uppercase tracking-widest text-xs">No data loaded</p>
                    </div>
                );
            }

            return (
                <div className="w-full relative overflow-x-auto custom-scrollbar touch-pan-x">
                    <table className="w-max min-w-full border-separate border-spacing-0">
                        <thead className="sticky top-0 z-[60]">
                            <tr className="bg-slate-800 text-white uppercase text-[9px] md:text-[10px] font-bold tracking-wider">
                                {visibleKeys.map((key) => {
                                    const { align, width } = getColStyle(key);
                                    const isFixedNo = key === "No";
                                    const isFixedSO = key === "SalesOrderDeliveryCode";
                                    const isSorted = sortConfig.key === key;
                                    
                                    const thStyle = {
                                        width, minWidth: width, maxWidth: width,
                                        left: isFixedNo ? '0px' : isFixedSO ? '50px' : 'auto',
                                        position: (isFixedNo || isFixedSO) ? 'sticky' : 'relative',
                                        zIndex: (isFixedNo || isFixedSO) ? 75 : 10
                                    };

                                    return (
                                        <th 
                                            key={key} 
                                            style={thStyle}
                                            className={`px-3 md:px-4 pt-3 md:pt-4 pb-2 ${align} border-r border-slate-700 whitespace-nowrap overflow-visible bg-slate-800`}
                                        >
                                            <div 
                                                className="flex items-center justify-center gap-1 cursor-pointer hover:text-blue-300 transition-colors mb-2 select-none"
                                                onClick={() => handleSort(key)}
                                            >
                                                <span className="truncate">{key}</span>
                                                <span className="flex-shrink-0 w-3 text-blue-400">
                                                    {isSorted ? (
                                                        sortConfig.direction === 'asc' ? '↑' : '↓'
                                                    ) : (
                                                        <span className="opacity-20 text-[8px]">⇅</span>
                                                    )}
                                                </span>
                                            </div>
                                            
                                            <div className="px-1" onClick={e => e.stopPropagation()}>
                                                <input
                                                    type="text"
                                                    placeholder="Filter..."
                                                    value={headerFilters[key] || ""}
                                                    onChange={(e) => handleFilterChange(key, e.target.value)}
                                                    className="w-full bg-slate-700/50 border border-slate-600 rounded px-1.5 py-0.5 text-[8px] md:text-[9px] font-medium text-white placeholder:text-slate-500 focus:outline-none focus:border-blue-500 focus:bg-slate-700 transition-all"
                                                />
                                            </div>
                                        </th>
                                    );
                                })}
                            </tr>
                        </thead>
                        <tbody className="bg-white">
                            {filteredAndSortedRows.length === 0 ? (
                                <tr>
                                    <td colSpan={visibleKeys.length} className="py-20 text-center">
                                        <p className="text-slate-400 font-bold uppercase tracking-widest text-[10px]">No records match current filters</p>
                                    </td>
                                </tr>
                            ) : (
                                filteredAndSortedRows.map((row, idx) => (
                                    <tr key={idx} className="hover:bg-blue-50/40 transition-colors group">
                                        {visibleKeys.map((key) => {
                                            const { width } = getColStyle(key);
                                            const isFixedNo = key === "No";
                                            const isFixedSO = key === "SalesOrderDeliveryCode";

                                            const tdStyle = {
                                                width, minWidth: width, maxWidth: width,
                                                left: isFixedNo ? '0px' : isFixedSO ? '50px' : 'auto'
                                            };

                                            return (
                                                <td 
                                                    key={key} 
                                                    style={tdStyle}
                                                    className={getCellClass(key, row[key])}
                                                >
                                                    <div className="truncate">
                                                        {formatValue(key, row[key])}
                                                    </div>
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            );
        };

        const BulkSearch = ({ onSearch, inputText, setInputText, column, setColumn, logic, setLogic }) => {
            const handleProcess = () => {
                const rawList = inputText.split(/[\n,;]/);
                const cleanedList = rawList.map(item => item.trim()).filter(item => item.length > 0);
                onSearch(cleanedList, column, logic);
            };

            const handleClear = () => {
                setInputText('');
                onSearch([], column, logic);
            };

            return (
                <div className="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
                    <div className="flex items-center gap-2 mb-4 md:mb-6 border-b border-slate-100 pb-4">
                        <Icons.ClipboardList className="w-4 h-4 md:w-5 md:h-5 text-blue-600" />
                        <h3 className="font-bold text-slate-800 text-sm md:text-base">Bulk Filter Console</h3>
                    </div>
                    
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-6 mb-4 md:mb-6">
                        <div className="space-y-1.5">
                            <label className="text-[9px] md:text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">1. Lookup Target Column</label>
                            <select
                                value={column}
                                onChange={(e) => setColumn(e.target.value)}
                                className="w-full px-3 py-2 md:py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-xs md:text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-medium"
                            >
                                <option value="SalesOrderDeliveryCode">SalesOrderDeliveryCode - B</option>
                                <option value="Production Order">Production Order - K</option>
                                <option value="Sales Document">Sales Document - L</option>
                                <option value="Customer Code">Customer Code - Q</option>
                                <option value="Sub Brand">Sub Brand - T</option>
                                <option value="Customer PO Reference">Customer PO Reference - C</option>
                                <option value="Anything">Anything (Global Search)</option>
                            </select>
                        </div>

                        <div className="space-y-1.5">
                            <label className="text-[9px] md:text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">2. Match Strategy</label>
                            <select
                                value={logic}
                                onChange={(e) => setLogic(e.target.value)}
                                className="w-full px-3 py-2 md:py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-xs md:text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-medium"
                            >
                                <option value="Standard">Standard Match (Exact)</option>
                                <option value="LogicA">Logic A: Partial/Contains Match</option>
                                <option value="LogicB">Logic B: Processed Exact Match (Best for B)</option>
                            </select>
                        </div>
                    </div>
                    
                    <p className="text-[11px] md:text-sm text-slate-500 mb-3 md:mb-4">
                        Paste identifiers below. spaces will be removed automatically.
                    </p>

                    <div className="space-y-4">
                        <textarea
                            value={inputText}
                            onChange={(e) => setInputText(e.target.value)}
                            placeholder="Example:&#10;CCEFM-CCEO201566-20-1&#10;FB250006969"
                            className="w-full h-32 md:h-48 px-3 md:px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-xs md:text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all placeholder:text-slate-300"
                        ></textarea>

                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div className="flex flex-col gap-1">
                                {logic === 'LogicB' && column === 'SalesOrderDeliveryCode' && (
                                    <span className="inline-block self-start text-[8px] md:text-[9px] px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded font-bold uppercase">
                                        SO extraction active
                                    </span>
                                )}
                                <span className="text-[9px] md:text-xs text-slate-400 font-medium italic">
                                    * Multiple identifiers (newline or comma)
                                </span>
                            </div>
                            <div className="flex gap-2 md:gap-3 w-full sm:w-auto">
                                <button
                                    onClick={handleClear}
                                    className="flex-1 sm:flex-none px-4 py-2 text-xs md:text-sm font-semibold text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors"
                                >
                                    Clear
                                </button>
                                <button
                                    onClick={handleProcess}
                                    className="flex-1 sm:flex-none px-6 py-2 md:py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-xs md:text-sm font-semibold rounded-lg shadow-md shadow-blue-100 flex items-center justify-center gap-2 transition-all active:scale-95"
                                >
                                    <Icons.Search className="w-4 h-4" />
                                    Fetch Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const FilterPanel = ({ filters, setFilters, onApply, onClear, isAdvanced }) => {
            const handleChange = (e) => {
                const { name, value, type } = e.target;
                if (type === 'checkbox') {
                    setFilters(prev => ({ ...prev, [name]: e.target.checked }));
                } else {
                    setFilters(prev => ({ ...prev, [name]: value }));
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    onApply();
                }
            };

            return (
                <div className="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
                    <div className="flex items-center gap-2 mb-4 md:mb-6 border-b border-slate-100 pb-4">
                        <Icons.Filter className="w-4 h-4 md:w-5 md:h-5 text-blue-600" />
                        <h3 className="font-bold text-slate-800 text-sm md:text-base">{isAdvanced ? 'Advanced Multi-Criteria Filters' : 'Quick Search Filters'}</h3>
                    </div>
                    
                    <div className="space-y-4 md:space-y-6">
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 md:gap-4">
                            {[
                                { label: 'SO Del. Code (B)', name: 'salesOrderDeliveryCode', placeholder: 'Search B...' },
                                { label: 'Sales Doc (L)', name: 'salesDocument', placeholder: 'Search L...' },
                                { label: 'Prod. Order (K)', name: 'productionOrder', placeholder: 'Search K...' },
                                { label: 'Customer PO Ref (C)', name: 'customerPoReference', placeholder: 'Search C...' },
                                { label: 'Sub Brand (T)', name: 'subBrand', placeholder: 'Search T...' },
                                { label: 'Customer Code (Q)', name: 'customerCode', placeholder: 'Search Q...' }
                            ].map((field) => (
                                <div key={field.name} className="space-y-1.5">
                                    <label className="text-[9px] md:text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">{field.label}</label>
                                    <input
                                        type="text"
                                        name={field.name}
                                        value={filters[field.name]}
                                        onChange={handleChange}
                                        onKeyDown={handleKeyDown}
                                        placeholder={field.placeholder}
                                        className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                                    />
                                </div>
                            ))}
                        </div>

                        {isAdvanced && (
                            <>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-8 items-end border-t border-slate-50 pt-4">
                                    <div className="space-y-1.5">
                                        <label className="text-[9px] md:text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">SO Conf. Date Range (BD)</label>
                                        <div className="flex flex-col sm:flex-row items-center gap-2 sm:gap-3">
                                            <div className="w-full">
                                                <input
                                                    type="date"
                                                    name="soConfDateFrom"
                                                    value={filters.soConfDateFrom}
                                                    onChange={handleChange}
                                                    className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                                />
                                            </div>
                                            <span className="text-slate-400 text-[10px] font-bold hidden sm:inline">TO</span>
                                            <div className="w-full">
                                                <input
                                                    type="date"
                                                    name="soConfDateTo"
                                                    value={filters.soConfDateTo}
                                                    onChange={handleChange}
                                                    className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex flex-col sm:flex-row flex-wrap gap-3 sm:gap-6 items-start sm:items-center">
                                        <label className="flex items-center gap-2 cursor-pointer group">
                                            <input
                                                type="checkbox"
                                                name="ignoreBlankCustomerPoRef"
                                                checked={filters.ignoreBlankCustomerPoRef}
                                                onChange={handleChange}
                                                className="w-4 h-4 rounded text-blue-600 focus:ring-blue-500"
                                            />
                                            <span className="text-[10px] md:text-xs font-semibold text-slate-600 group-hover:text-slate-900">Ignore Blank PO Ref (C)</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer group">
                                            <input
                                                type="checkbox"
                                                name="ignoreBlankSoConfDate"
                                                checked={filters.ignoreBlankSoConfDate}
                                                onChange={handleChange}
                                                className="w-4 h-4 rounded text-blue-600 focus:ring-blue-500"
                                            />
                                            <span className="text-[10px] md:text-xs font-semibold text-slate-600 group-hover:text-slate-900">Ignore Blank SO Date (BD)</span>
                                        </label>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 md:gap-4 border-t border-slate-50 pt-4">
                                    <div className="space-y-1.5">
                                        <label className="text-[9px] md:text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Sales Document (L)</label>
                                        <select
                                            name="hasSalesDocument"
                                            value={filters.hasSalesDocument}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                        >
                                            <option value="all">All Records</option>
                                            <option value="true">True (Has Value)</option>
                                            <option value="false">False (Is Blank)</option>
                                        </select>
                                    </div>
                                    <div className="space-y-1.5">
                                        <label className="text-[9px] md:text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Picking List (N)</label>
                                        <select
                                            name="hasPickingList"
                                            value={filters.hasPickingList}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                        >
                                            <option value="all">All Records</option>
                                            <option value="true">True (Has Value)</option>
                                            <option value="false">False (Is Blank)</option>
                                        </select>
                                    </div>
                                    <div className="space-y-1.5">
                                        <label className="text-[9px] md:text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">FG Ready Qty (A)</label>
                                        <select
                                            name="hasFGReadyQtyA"
                                            value={filters.hasFGReadyQtyA}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                        >
                                            <option value="all">All Records</option>
                                            <option value="true">True (Qty > 0)</option>
                                            <option value="false">False (Qty ≤ 0 / Blank)</option>
                                        </select>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>

                    <div className="flex flex-col sm:flex-row justify-end gap-2 md:gap-3 mt-4 md:mt-6 pt-4 md:pt-6 border-t border-slate-100">
                        <button
                            onClick={onClear}
                            className="w-full sm:w-auto px-6 py-2 text-xs md:text-sm font-semibold text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors"
                        >
                            Reset All
                        </button>
                        <button
                            onClick={onApply}
                            className="w-full sm:w-auto px-8 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-xs md:text-sm font-semibold rounded-lg shadow-md shadow-blue-100 flex items-center justify-center gap-2 transition-all active:scale-95"
                        >
                            <Icons.Search className="w-4 h-4" />
                            Apply Filters
                        </button>
                    </div>
                </div>
            );
        };

        const Instructions = ({ dataSheet, instructions, setInstructions }) => {
            const [loading, setLoading] = React.useState(false);
            const [filters, setFilters] = React.useState({ date: '', customer: 'All', status: 'All' });

            const cleanStr = (val) => {
                if (val == null) return "";
                const s = String(val);
                let result = "";
                for (let i = 0; i < s.length; i++) {
                    const charCode = s.charCodeAt(i);
                    if (charCode !== 32 && charCode !== 9 && charCode !== 10 && charCode !== 13 && charCode !== 160) {
                        result += s[i];
                    }
                }
                return result;
            };

            const formatShortDate = (date) => {
                if (!date) return "-";
                let d;
                if (typeof date === 'number') {
                    d = new Date((date - 25569) * 86400 * 1000);
                } else {
                    d = new Date(date);
                }
                if (isNaN(d.getTime())) return String(date);
                return d.toLocaleDateString('en-GB');
            };

            const evaluateFinalStatus = (row) => {
                if (!row) return "Not Ready for Invoicing";
                const aw_dispatchPending = Number(row["Dispatch Pending Qty"] || 0);
                const av_invoicePending = Number(row["Invoice Pending Qty"] || 0);
                const au_shippingPending = Number(row["Shipping Pending Qty"] || 0);
                const an_approvedReady = Number(row["FG Ready Qty (A)"] || 0);
                const ao_pendingReady = Number(row["FG Ready Qty (P)"] || 0);
                const aj_transitQty = Number(row["FG Transit Qty"] || 0);
                const bj_remarks = String(row["Remarks"] || "").trim();
                const bm_portalResponse = String(row["Portal Response"] || "").trim();
                const m_salesDocStatus = String(row["SalesDocStatus"] || "").trim().toUpperCase();
                const o_pickingStatus = String(row["Picking Status"] || "").trim().toUpperCase();
                const p_invoiceNum = String(row["Invoice Num"] || "").trim();
                const l_salesDoc = String(row["Sales Document"] || "").trim();
                const n_pickingList = String(row["Picking List"] || "").trim();

                if (aw_dispatchPending > 0 && p_invoiceNum !== "") return "Ready for Dispatch";
                if (av_invoicePending > 0) return "Ready for Invoicing";
                if (o_pickingStatus === "COMPLETE" && au_shippingPending > 0) {
                    if (bj_remarks !== "") return "Ready for Definitive / Error";
                    return "Ready for Definitive";
                }
                if (m_salesDocStatus === "ENTERED" && bm_portalResponse === "") return "Separation Pending";
                if (bm_portalResponse !== "") return "Mismatch";
                if ((l_salesDoc !== "" && n_pickingList === "") || (an_approvedReady > 0 && l_salesDoc === "")) return "Picking List Pending";
                if (ao_pendingReady > 0) return "Approval Pending";
                if (aj_transitQty > 0) return "In Transit";
                return "Not Ready for Invoicing";
            };

            const handleInstructionUpload = (file) => {
                setLoading(true);
                const reader = new FileReader();
                reader.onload = (e) => {
                    const binaryStr = e.target.result;
                    const workbook = XLSX.read(binaryStr, { type: 'binary' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    const processed = jsonData.slice(1).flatMap((rowArr) => {
                        const rawSO = rowArr[3];
                        const rawPO = rowArr[4];
                        if (!rawSO) return [];
                        const baseInst = {
                            Date: rowArr[0],
                            CustomerCode: String(rowArr[1] || ""),
                            CRE: String(rowArr[2] || ""),
                            SalesOrder: String(rawSO).trim(),
                            ProductionOrder: String(rawPO || "").trim(),
                            InstructionTime: rowArr[5],
                            Location: String(rowArr[6] || ""),
                        };
                        const cleanSO_Ins = cleanStr(baseInst.SalesOrder).toLowerCase();
                        const matches = dataSheet.filter(d => {
                            const dSO = cleanStr(d["SalesOrderDeliveryCode"]).toLowerCase();
                            return dSO === cleanSO_Ins || dSO.includes(cleanSO_Ins) || cleanSO_Ins.includes(dSO);
                        });
                        if (matches.length > 0) {
                            const uniqueSalesDocs = new Map();
                            matches.forEach(m => {
                                const docKey = String(m["Sales Document"] || "BLANK");
                                if (!uniqueSalesDocs.has(docKey)) uniqueSalesDocs.set(docKey, m);
                            });
                            return Array.from(uniqueSalesDocs.values()).map(matchRow => ({
                                ...baseInst,
                                MatchedData: matchRow,
                                Status: evaluateFinalStatus(matchRow)
                            }));
                        } else {
                            return [{ ...baseInst, Status: "Not Ready for Invoicing", MatchedData: null }];
                        }
                    });
                    setInstructions(processed);
                    setLoading(false);
                };
                reader.readAsBinaryString(file);
            };

            const handleDownload = () => {
                if (instructions.length === 0) return;
                const exportData = instructions.map(inst => ({
                    'Date': formatShortDate(inst.Date),
                    'Customer': inst.CustomerCode,
                    'Sales Order': inst.SalesOrder,
                    'Production Order': inst.ProductionOrder,
                    'Final Process Status': inst.Status,
                    'Reference (Inv/SD/PL)': inst.MatchedData ? 
                        `${inst.MatchedData["Invoice Num"] || ""} / ${inst.MatchedData["Sales Document"] || ""} / ${inst.MatchedData["Picking List"] || ""}` : "-",
                    'Remarks (BJ)': inst.MatchedData?.["Remarks"] || "",
                    'Portal Response (BM)': inst.MatchedData?.["Portal Response"] || ""
                }));
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Instruction_Process_Analysis");
                XLSX.writeFile(wb, `SO_Status_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            const handleClear = () => {
                setInstructions([]);
            };

            const filteredInstructions = React.useMemo(() => {
                return instructions.filter(i => {
                    const matchDate = !filters.date || String(i.Date).toLowerCase().includes(filters.date.toLowerCase());
                    const matchCust = filters.customer === 'All' || i.CustomerCode === filters.customer;
                    const matchStatus = filters.status === 'All' || i.Status === filters.status;
                    return matchDate && matchCust && matchStatus;
                });
            }, [instructions, filters]);

            const getStatusColor = (status) => {
                switch(status) {
                    case "Ready for Dispatch": return "bg-green-100 text-green-800 border-green-200";
                    case "Ready for Invoicing": return "bg-blue-100 text-blue-800 border-blue-200";
                    case "Ready for Definitive / Error": return "bg-red-50 text-red-700 border-red-200 font-bold";
                    case "Ready for Definitive": return "bg-sky-100 text-sky-800 border-sky-200";
                    case "Separation Pending": return "bg-amber-100 text-amber-800 border-amber-200";
                    case "Mismatch": return "bg-orange-100 text-orange-800 border-orange-300 font-bold";
                    case "Picking List Pending": return "bg-slate-100 text-slate-600 border-slate-200";
                    case "Approval Pending": return "bg-purple-100 text-purple-800 border-purple-200";
                    case "In Transit": return "bg-teal-100 text-teal-800 border-teal-200";
                    case "Not Ready for Invoicing": return "bg-slate-50 text-slate-400 border-slate-100 italic";
                    default: return "bg-slate-50 text-slate-500 border-slate-200";
                }
            };

            return (
                <div className="space-y-4">
                    <div className="bg-white px-4 md:px-6 py-4 rounded-xl shadow-sm border border-slate-200 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-4 w-full sm:w-auto">
                            <div className="bg-indigo-600 p-2 rounded-lg text-white">
                                <Icons.ClipboardList className="w-6 h-6" />
                            </div>
                            <div>
                                <h2 className="text-xl font-bold text-slate-900 tracking-tight">Instruction Tracker</h2>
                                <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Process Logic v3.0</p>
                            </div>
                        </div>
                        
                        <div className="flex flex-wrap items-center gap-2 w-full sm:w-auto">
                            <input 
                                type="file" 
                                id="logic-sync-file" 
                                className="hidden" 
                                accept=".xlsx, .xls"
                                onChange={(e) => e.target.files && handleInstructionUpload(e.target.files[0])}
                            />
                            <label 
                                htmlFor="logic-sync-file"
                                className="flex-1 sm:flex-none px-4 md:px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-[10px] md:text-xs font-bold rounded-lg cursor-pointer transition-all shadow-sm flex items-center justify-center gap-2 active:scale-95"
                            >
                                <Icons.Upload className="w-4 h-4" />
                                {loading ? "Analyzing..." : "Sync Instructions"}
                            </label>
                            
                            {instructions.length > 0 && (
                                <>
                                    <button 
                                        onClick={handleDownload}
                                        className="flex-1 sm:flex-none px-4 md:px-5 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] md:text-xs font-bold rounded-lg transition-all shadow-sm flex items-center justify-center gap-2 active:scale-95"
                                    >
                                        <Icons.Download className="w-4 h-4" />
                                        Download Report
                                    </button>
                                    <button 
                                        onClick={handleClear}
                                        className="flex-1 sm:flex-none px-4 md:px-5 py-2 text-red-500 hover:text-red-700 hover:bg-red-50 text-[10px] md:text-xs font-bold rounded-lg transition-all flex items-center justify-center gap-2"
                                    >
                                        <Icons.XMark className="w-4 h-4" />
                                        Clear
                                    </button>
                                </>
                            )}
                        </div>
                    </div>

                    {instructions.length > 0 ? (
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="overflow-x-auto custom-scrollbar">
                                <table className="w-full text-left border-separate border-spacing-0">
                                    <thead>
                                        <tr className="bg-slate-800 text-white text-[9px] md:text-[10px] uppercase font-bold tracking-wider">
                                            <th className="px-4 md:px-6 py-3 md:py-4 border-r border-slate-700 w-[100px] whitespace-nowrap">Date</th>
                                            <th className="px-4 md:px-6 py-3 md:py-4 border-r border-slate-700 w-[180px] whitespace-nowrap">Sales Order</th>
                                            <th className="px-4 md:px-6 py-3 md:py-4 border-r border-slate-700 w-[120px] whitespace-nowrap">Prod Order</th>
                                            <th className="px-4 md:px-6 py-3 md:py-4 bg-indigo-700 border-r border-indigo-600 text-center w-[200px] whitespace-nowrap">Status</th>
                                            <th className="px-4 md:px-6 py-3 md:py-4 border-r border-slate-700 w-[300px] text-center text-slate-400 font-mono text-[9px] tracking-widest whitespace-nowrap">INV / SD / PL Ref</th>
                                            <th className="px-4 md:px-6 py-3 md:py-4 border-r border-slate-700 w-[200px] whitespace-nowrap">Remarks</th>
                                            <th className="px-4 md:px-6 py-3 md:py-4 w-[200px] whitespace-nowrap">Portal Response</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {filteredInstructions.map((inst, idx) => (
                                            <tr key={idx} className="hover:bg-slate-50 transition-colors">
                                                <td className="px-4 md:px-6 py-3 text-[10px] md:text-[11px] text-slate-500 font-medium">{formatShortDate(inst.Date)}</td>
                                                <td className="px-4 md:px-6 py-3 text-[10px] md:text-[11px] text-indigo-700 font-bold font-mono truncate max-w-[150px]">{inst.SalesOrder}</td>
                                                <td className="px-4 md:px-6 py-3 text-[10px] md:text-[11px] text-slate-400 font-mono">{inst.ProductionOrder || "---"}</td>
                                                <td className="px-4 md:px-6 py-3 whitespace-nowrap">
                                                    <div className="flex justify-center">
                                                        <span className={`px-2 md:px-3 py-1 md:py-1.5 rounded-md text-[9px] md:text-[10px] font-bold border uppercase tracking-wider ${getStatusColor(inst.Status)}`}>
                                                            {inst.Status}
                                                        </span>
                                                    </div>
                                                </td>
                                                <td className="px-4 md:px-6 py-3 text-[10px] md:text-[11px] font-mono text-slate-600 text-center bg-slate-50/20">
                                                    {inst.MatchedData ? (
                                                        <div className="flex items-center justify-center gap-1 md:gap-2">
                                                            <span className={inst.MatchedData["Invoice Num"] ? "text-emerald-600 font-bold" : "text-slate-300"}>{inst.MatchedData["Invoice Num"] || "---"}</span>
                                                            <span className="text-slate-200">|</span>
                                                            <span className={inst.MatchedData["Sales Document"] ? "text-indigo-600 font-bold" : "text-slate-300"}>{inst.MatchedData["Sales Document"] || "---"}</span>
                                                            <span className="text-slate-200">|</span>
                                                            <span className={inst.MatchedData["Picking List"] ? "text-amber-600 font-bold" : "text-slate-300"}>{inst.MatchedData["Picking List"] || "---"}</span>
                                                        </div>
                                                    ) : (
                                                        <span className="text-slate-300 italic text-[9px] md:text-[10px] uppercase">No Match</span>
                                                    )}
                                                </td>
                                                <td className="px-4 md:px-6 py-3 text-[10px] md:text-[11px] text-slate-600">
                                                    <div className="max-w-[180px] truncate" title={String(inst.MatchedData?.["Remarks"] || "")}>
                                                        {inst.MatchedData?.["Remarks"] || "---"}
                                                    </div>
                                                </td>
                                                <td className="px-4 md:px-6 py-3 text-[10px] md:text-[11px] text-slate-600">
                                                    <div className="max-w-[180px] truncate" title={String(inst.MatchedData?.["Portal Response"] || "")}>
                                                        {inst.MatchedData?.["Portal Response"] || "---"}
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            <div className="bg-slate-50 px-4 md:px-6 py-3 border-t border-slate-200 flex justify-between items-center">
                                <span className="text-[9px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest">{filteredInstructions.length} Lines Analyzed</span>
                                <span className="text-[9px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest italic">COMTRACK Process Hub</span>
                            </div>
                        </div>
                    ) : (
                        <div className="min-h-[300px] md:h-[400px] bg-white rounded-xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-center p-6 md:p-10 hover:border-indigo-300 transition-all">
                            <div className="bg-slate-50 p-4 md:p-6 rounded-full mb-4 md:mb-6 border border-slate-100">
                                <Icons.ClipboardList className="w-10 h-10 md:w-12 md:h-12 text-slate-300" />
                            </div>
                            <h3 className="text-slate-800 font-bold text-lg md:text-2xl tracking-tight uppercase">Instruction Analysis</h3>
                            <p className="text-slate-500 text-xs md:text-sm max-w-sm mt-2 font-medium">
                                Sync your SO instructions to visualize current process stages from Transit to Dispatch.
                            </p>
                        </div>
                    )}
                </div>
            );
        };

        const InstructionsV2 = ({ dataSheet, instructions, setInstructions }) => {
            const [gridInput, setGridInput] = React.useState('');
            
            const cleanStr = (val) => {
                if (val == null) return "";
                const s = String(val);
                let result = "";
                for (let i = 0; i < s.length; i++) {
                    const charCode = s.charCodeAt(i);
                    if (charCode !== 32 && charCode !== 9 && charCode !== 10 && charCode !== 13 && charCode !== 160) {
                        result += s[i];
                    }
                }
                return result;
            };

            const evaluateFinalStatus = (row) => {
                if (!row) return "Not Ready for Invoicing";
                const aw_dispatchPending = Number(row["Dispatch Pending Qty"] || 0);
                const av_invoicePending = Number(row["Invoice Pending Qty"] || 0);
                const au_shippingPending = Number(row["Shipping Pending Qty"] || 0);
                const an_approvedReady = Number(row["FG Ready Qty (A)"] || 0);
                const ao_pendingReady = Number(row["FG Ready Qty (P)"] || 0);
                const aj_transitQty = Number(row["FG Transit Qty"] || 0);
                const bj_remarks = String(row["Remarks"] || "").trim();
                const bm_portalResponse = String(row["Portal Response"] || "").trim();
                const m_salesDocStatus = String(row["SalesDocStatus"] || "").trim().toUpperCase();
                const o_pickingStatus = String(row["Picking Status"] || "").trim().toUpperCase();
                const p_invoiceNum = String(row["Invoice Num"] || "").trim();
                const l_salesDoc = String(row["Sales Document"] || "").trim();
                const n_pickingList = String(row["Picking List"] || "").trim();

                if (aw_dispatchPending > 0 && p_invoiceNum !== "") return "Ready for Dispatch";
                if (av_invoicePending > 0) return "Ready for Invoicing";
                if (o_pickingStatus === "COMPLETE" && au_shippingPending > 0) {
                    if (bj_remarks !== "") return "Ready for Definitive / Error";
                    return "Ready for Definitive";
                }
                if (m_salesDocStatus === "ENTERED" && bm_portalResponse === "") return "Separation Pending";
                if (bm_portalResponse !== "") return "Mismatch";
                if ((l_salesDoc !== "" && n_pickingList === "") || (an_approvedReady > 0 && l_salesDoc === "")) return "Picking List Pending";
                if (ao_pendingReady > 0) return "Approval Pending";
                if (aj_transitQty > 0) return "In Transit";
                return "Not Ready for Invoicing";
            };

            const parsedLines = React.useMemo(() => {
                if (!gridInput.trim()) return [];
                return gridInput.split('\n').filter(line => line.trim().length > 0).map(line => {
                    const columns = line.split('\t');
                    return {
                        so: columns[0]?.trim() || "",
                        po: columns[1]?.trim() || ""
                    };
                });
            }, [gridInput]);

            const handleProcess = () => {
                if (parsedLines.length === 0) return;

                const processed = parsedLines.flatMap((entry) => {
                    const { so: rawSO, po: rawPO } = entry;

                    const baseInst = {
                        Date: new Date().toISOString(),
                        CustomerCode: "MANUAL",
                        CRE: "MANUAL",
                        SalesOrder: rawSO,
                        ProductionOrder: rawPO,
                        InstructionTime: "",
                        Location: "",
                    };

                    const cleanSO_Input = cleanStr(rawSO).toLowerCase();
                    const cleanPO_Input = cleanStr(rawPO).toLowerCase();

                    const matches = dataSheet.filter(d => {
                        const dSO = cleanStr(d["SalesOrderDeliveryCode"]).toLowerCase();
                        const dPO = cleanStr(d["Production Order"]).toLowerCase();
                        
                        const soMatch = rawSO ? (dSO === cleanSO_Input || dSO.includes(cleanSO_Input) || cleanSO_Input.includes(dSO)) : true;
                        const poMatch = rawPO ? (dPO === cleanPO_Input || dPO.includes(cleanPO_Input) || cleanPO_Input.includes(dPO)) : true;

                        if (rawSO && rawPO) return soMatch && poMatch;
                        return rawSO ? soMatch : poMatch;
                    });

                    if (matches.length > 0) {
                        return matches.map(matchRow => ({
                            ...baseInst,
                            MatchedData: matchRow,
                            Status: evaluateFinalStatus(matchRow)
                        }));
                    } else {
                        return [{ ...baseInst, Status: "Not Ready for Invoicing", MatchedData: null }];
                    }
                });

                setInstructions(processed);
            };

            const handleClear = () => {
                setGridInput('');
                setInstructions([]);
            };

            const handleDownload = () => {
                if (instructions.length === 0) return;
                const exportData = instructions.map(inst => ({
                    'Sales Order': inst.SalesOrder,
                    'Production Order': inst.ProductionOrder,
                    'Final Process Status': inst.Status,
                    'Reference (Inv/SD/PL)': inst.MatchedData ? 
                        `${inst.MatchedData["Invoice Num"] || ""} / ${inst.MatchedData["Sales Document"] || ""} / ${inst.MatchedData["Picking List"] || ""}` : "-",
                    'Remarks (BJ)': inst.MatchedData?.["Remarks"] || "",
                    'Portal Response (BM)': inst.MatchedData?.["Portal Response"] || ""
                }));
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Manual_Analysis");
                XLSX.writeFile(wb, `Manual_Status_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            const getStatusColor = (status) => {
                switch(status) {
                    case "Ready for Dispatch": return "bg-green-100 text-green-800 border-green-200";
                    case "Ready for Invoicing": return "bg-blue-100 text-blue-800 border-blue-200";
                    case "Ready for Definitive / Error": return "bg-red-50 text-red-700 border-red-200 font-bold";
                    case "Ready for Definitive": return "bg-sky-100 text-sky-800 border-sky-200";
                    case "Separation Pending": return "bg-amber-100 text-amber-800 border-amber-200";
                    case "Mismatch": return "bg-orange-100 text-orange-800 border-orange-300 font-bold";
                    case "Picking List Pending": return "bg-slate-100 text-slate-600 border-slate-200";
                    case "Approval Pending": return "bg-purple-100 text-purple-800 border-purple-200";
                    case "In Transit": return "bg-teal-100 text-teal-800 border-teal-200";
                    case "Not Ready for Invoicing": return "bg-slate-50 text-slate-400 border-slate-100 italic";
                    default: return "bg-slate-50 text-slate-500 border-slate-200";
                }
            };

            return (
                <div className="space-y-4">
                    <div className="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
                        <div className="flex items-center justify-between mb-4 md:mb-6 border-b border-slate-100 pb-4">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-lg text-white">
                                    <Icons.Table className="w-5 h-5" />
                                </div>
                                <div>
                                    <h3 className="font-bold text-slate-800 text-sm md:text-base uppercase tracking-tight">Manual Instruction Entry (V2)</h3>
                                    <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Copy directly from Excel columns</p>
                                </div>
                            </div>
                        </div>

                        <div className="space-y-4">
                            <div className="relative group">
                                <div className="absolute top-3 left-4 pointer-events-none transition-opacity duration-300 group-focus-within:opacity-0">
                                    {!gridInput && (
                                        <div className="space-y-1">
                                            <p className="text-slate-300 font-mono text-xs">SO_CODE_01 [TAB] PO_BATCH_01</p>
                                            <p className="text-slate-300 font-mono text-xs">SO_CODE_02 [TAB] PO_BATCH_02</p>
                                        </div>
                                    )}
                                </div>
                                <textarea
                                    value={gridInput}
                                    onChange={(e) => setGridInput(e.target.value)}
                                    placeholder=" "
                                    className="w-full h-48 md:h-64 px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-xs md:text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all custom-scrollbar leading-relaxed"
                                    style={{
                                        backgroundImage: 'linear-gradient(rgba(0,0,0,0.02) 1px, transparent 1px)',
                                        backgroundSize: '100% 1.5rem'
                                    }}
                                ></textarea>
                                
                                {parsedLines.length > 0 && (
                                    <div className="absolute bottom-4 right-4 bg-white/90 backdrop-blur px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm">
                                        <span className="text-[10px] font-bold text-blue-600 uppercase tracking-widest">
                                            {parsedLines.length} Lines Detected
                                        </span>
                                    </div>
                                )}
                            </div>

                            <div className="flex flex-col sm:flex-row justify-between items-center gap-4 pt-2">
                                <div className="text-[10px] text-slate-400 max-w-sm">
                                    <span className="font-bold text-slate-500 uppercase">Pro Tip:</span> In Excel, select your <span className="text-slate-700 font-bold">SO</span> and <span className="text-slate-700 font-bold">PO</span> columns side-by-side, Copy (Ctrl+C), and Paste (Ctrl+V) here.
                                </div>
                                
                                <div className="flex gap-3 w-full sm:w-auto">
                                    <button
                                        onClick={handleClear}
                                        className="px-6 py-2.5 text-xs md:text-sm font-bold text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg transition-all uppercase tracking-wide"
                                    >
                                        Clear Entry
                                    </button>
                                    <button
                                        onClick={handleProcess}
                                        disabled={parsedLines.length === 0}
                                        className="flex-1 sm:flex-none px-10 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-200 disabled:cursor-not-allowed text-white text-xs md:text-sm font-bold rounded-lg shadow-lg shadow-blue-100 flex items-center justify-center gap-2 transition-all active:scale-95 uppercase tracking-wider"
                                    >
                                        <Icons.Search className="w-4 h-4" />
                                        Run Matching Logic
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {instructions.length > 0 && (
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden animate-in fade-in slide-in-from-bottom-2 duration-300">
                            <div className="px-4 md:px-6 py-4 border-b border-slate-200 bg-slate-50/50 flex justify-between items-center">
                                <h2 className="text-[10px] md:text-xs font-bold text-slate-800 uppercase tracking-widest flex items-center gap-2">
                                    <Icons.ClipboardList className="w-4 h-4 text-blue-600" />
                                    Instruction Sync Report
                                </h2>
                                <button 
                                    onClick={handleDownload}
                                    className="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] font-bold rounded-md transition-all flex items-center gap-2 shadow-sm"
                                >
                                    <Icons.Download className="w-3.5 h-3.5" />
                                    Download CSV
                                </button>
                            </div>
                            
                            <div className="overflow-x-auto custom-scrollbar">
                                <table className="w-full text-left border-separate border-spacing-0">
                                    <thead>
                                        <tr className="bg-slate-800 text-white text-[9px] md:text-[10px] uppercase font-bold tracking-wider">
                                            <th className="px-4 md:px-6 py-3 md:py-4 border-r border-slate-700 w-[200px] whitespace-nowrap">Input: Sales Order</th>
                                            <th className="px-4 md:px-6 py-3 md:py-4 border-r border-slate-700 w-[180px] whitespace-nowrap">Input: Prod Order</th>
                                            <th className="px-4 md:px-6 py-3 md:py-4 bg-blue-700 border-r border-blue-600 text-center w-[200px] whitespace-nowrap">Process Status</th>
                                            <th className="px-4 md:px-6 py-3 md:py-4 border-r border-slate-700 w-[300px] text-center text-slate-400 font-mono text-[9px] tracking-widest whitespace-nowrap">INV / SD / PL Ref</th>
                                            <th className="px-4 md:px-6 py-3 md:py-4 border-r border-slate-700 w-[200px] whitespace-nowrap">Remarks</th>
                                            <th className="px-4 md:px-6 py-3 md:py-4 w-[200px] whitespace-nowrap">Portal Response</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {instructions.map((inst, idx) => (
                                            <tr key={idx} className="hover:bg-slate-50 transition-colors">
                                                <td className="px-4 md:px-6 py-3 text-[10px] md:text-[11px] text-blue-700 font-bold font-mono truncate max-w-[200px]" title={inst.SalesOrder}>
                                                    {inst.SalesOrder || "---"}
                                                </td>
                                                <td className="px-4 md:px-6 py-3 text-[10px] md:text-[11px] text-purple-600 font-bold font-mono truncate max-w-[180px]">
                                                    {inst.ProductionOrder || "---"}
                                                </td>
                                                <td className="px-4 md:px-6 py-3 whitespace-nowrap">
                                                    <div className="flex justify-center">
                                                        <span className={`px-2 md:px-3 py-1 md:py-1.5 rounded-md text-[9px] md:text-[10px] font-bold border uppercase tracking-wider ${getStatusColor(inst.Status)}`}>
                                                            {inst.Status}
                                                        </span>
                                                    </div>
                                                </td>
                                                <td className="px-4 md:px-6 py-3 text-[10px] md:text-[11px] font-mono text-slate-600 text-center bg-slate-50/20">
                                                    {inst.MatchedData ? (
                                                        <div className="flex items-center justify-center gap-1 md:gap-2">
                                                            <span className={inst.MatchedData["Invoice Num"] ? "text-emerald-600 font-bold" : "text-slate-300"}>{inst.MatchedData["Invoice Num"] || "---"}</span>
                                                            <span className="text-slate-200">|</span>
                                                            <span className={inst.MatchedData["Sales Document"] ? "text-indigo-600 font-bold" : "text-slate-300"}>{inst.MatchedData["Sales Document"] || "---"}</span>
                                                            <span className="text-slate-200">|</span>
                                                            <span className={inst.MatchedData["Picking List"] ? "text-amber-600 font-bold" : "text-slate-300"}>{inst.MatchedData["Picking List"] || "---"}</span>
                                                        </div>
                                                    ) : (
                                                        <span className="text-slate-300 italic text-[9px] md:text-[10px] uppercase">No Record Found</span>
                                                    )}
                                                </td>
                                                <td className="px-4 md:px-6 py-3 text-[10px] md:text-[11px] text-slate-600">
                                                    <div className="max-w-[180px] truncate" title={String(inst.MatchedData?.["Remarks"] || "")}>
                                                        {inst.MatchedData?.["Remarks"] || "---"}
                                                    </div>
                                                </td>
                                                <td className="px-4 md:px-6 py-3 text-[10px] md:text-[11px] text-slate-600">
                                                    <div className="max-w-[180px] truncate" title={String(inst.MatchedData?.["Portal Response"] || "")}>
                                                        {inst.MatchedData?.["Portal Response"] || "---"}
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            <div className="bg-slate-50 px-4 md:px-6 py-3 border-t border-slate-200 flex justify-between items-center">
                                <span className="text-[9px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                    {instructions.length} Instructions Verified
                                </span>
                                <span className="text-[9px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest italic">
                                    Unified Column Parsing Active
                                </span>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Settings = ({ settings, onUpdate }) => {
            const pages = [
                { id: 'preview', label: 'Data Preview Page' },
                { id: 'bulk', label: 'Bulk Filter Page' }
            ];

            return (
                <div className="space-y-8 pb-20">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <div className="flex items-center gap-2 mb-6 border-b border-slate-100 pb-4">
                            <Icons.ClipboardList className="w-5 h-5 text-blue-600" />
                            <h3 className="font-bold text-slate-800">Application Configuration</h3>
                        </div>
                        <p className="text-sm text-slate-500 mb-8">
                            Configure which data columns are visible and their text alignment for each functional page of the app.
                        </p>

                        <div className="space-y-12">
                            {pages.map(page => (
                                <div key={page.id} className="space-y-4">
                                    <div className="flex items-center gap-3">
                                        <div className="h-6 w-1 bg-blue-600 rounded-full"></div>
                                        <h4 className="font-bold text-slate-700">{page.label} Settings</h4>
                                    </div>

                                    <div className="bg-slate-50 rounded-xl border border-slate-200 overflow-hidden">
                                        <table className="w-full text-left border-collapse">
                                            <thead>
                                                <tr className="bg-slate-100 text-[10px] uppercase font-bold text-slate-500 tracking-wider">
                                                    <th className="px-6 py-3">Visibility</th>
                                                    <th className="px-6 py-3">Column Name</th>
                                                    <th className="px-6 py-3">Alignment</th>
                                                    <th className="px-6 py-3">Width Mode</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-200 bg-white">
                                                {COLUMN_KEYS.map(key => {
                                                    const config = settings[page.id].columns[key];
                                                    return (
                                                        <tr key={key} className="hover:bg-blue-50/30 transition-colors">
                                                            <td className="px-6 py-3 w-[120px]">
                                                                <label className="relative inline-flex items-center cursor-pointer">
                                                                    <input 
                                                                        type="checkbox" 
                                                                        checked={config.visible} 
                                                                        onChange={(e) => onUpdate(page.id, key, { visible: e.target.checked })}
                                                                        className="sr-only peer" 
                                                                    />
                                                                    <div className="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                                                </label>
                                                            </td>
                                                            <td className="px-6 py-3">
                                                                <span className={`text-xs font-medium ${config.visible ? 'text-slate-800' : 'text-slate-400'}`}>
                                                                    {key}
                                                                </span>
                                                            </td>
                                                            <td className="px-6 py-3 w-[200px]">
                                                                <select 
                                                                    value={config.align}
                                                                    disabled={!config.visible}
                                                                    onChange={(e) => onUpdate(page.id, key, { align: e.target.value })}
                                                                    className="text-xs bg-slate-50 border border-slate-200 rounded px-2 py-1 outline-none focus:ring-1 focus:ring-blue-500 disabled:opacity-50"
                                                                >
                                                                    <option value="text-left">Align Left</option>
                                                                    <option value="text-center">Center</option>
                                                                    <option value="text-right">Align Right</option>
                                                                </select>
                                                            </td>
                                                            <td className="px-6 py-3 w-[200px]">
                                                                <select 
                                                                    value={config.width === 'auto' ? 'auto' : 'fixed'}
                                                                    disabled={!config.visible}
                                                                    onChange={(e) => onUpdate(page.id, key, { width: e.target.value === 'auto' ? 'auto' : '160px' })}
                                                                    className="text-xs bg-slate-50 border border-slate-200 rounded px-2 py-1 outline-none focus:ring-1 focus:ring-blue-500 disabled:opacity-50"
                                                                >
                                                                    <option value="auto">Auto (Flexible)</option>
                                                                    <option value="fixed">Fixed Width</option>
                                                                </select>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---

        const App = () => {
            const [data, setData] = React.useState([]);
            const [mainFilteredData, setMainFilteredData] = React.useState([]);
            const [standaloneFilteredData, setStandaloneFilteredData] = React.useState([]);
            const [instructionsData, setInstructionsData] = React.useState([]);
            const [instructionsV2Data, setInstructionsV2Data] = React.useState([]);
            const [isLoaded, setIsLoaded] = React.useState(false);
            const [loading, setLoading] = React.useState(false);
            const [activeTab, setActiveTab] = React.useState('preview');

            const initialColumnConfig = (page) => {
                const configs = {};
                const getBulkAlignment = (key) => {
                    const left = ["Delivery Address", "Remarks", "Portal Response"];
                    const right = ["SO Del. Qty", "FG Transit Qty", "FG Ready Qty (A)", "FG Ready Qty (P)"];
                    if (left.includes(key)) return 'text-left';
                    if (right.includes(key)) return 'text-right';
                    return 'text-center';
                };

                const bulkVisible = [
                    "No", "SalesOrderDeliveryCode", "Customer PO Reference", "SO Del. Qty",
                    "SOL Status", "Production Order", "Sales Document", "SalesDocStatus",
                    "Picking List", "Picking Status", "Invoice Num", "Customer Code",
                    "Customer", "FG Transit Qty", "FG Ready Qty (A)", "FG Ready Qty (P)",
                    "P&R Ele. Count", "SO Conf. Date", "Shipped Date", "Invoice Date",
                    "Delivery Address", "Remarks", "Portal Response"
                ];

                COLUMN_KEYS.forEach(key => {
                    // Start with default
                    let config = {
                        visible: true,
                        align: 'text-center',
                        width: '160px' 
                    };

                    // Apply User Specific Overrides (Visibility/Width/Align)
                    // Note: Visibility in overrides might conflict with Bulk list logic, 
                    // so we only apply Width/Align from User Config here to start.
                    if (USER_COLUMN_CONFIG[key]) {
                        if (USER_COLUMN_CONFIG[key].align) config.align = USER_COLUMN_CONFIG[key].align;
                        if (USER_COLUMN_CONFIG[key].width) config.width = USER_COLUMN_CONFIG[key].width;
                    }

                    // Apply Page Specific Logic
                    if (page === 'bulk') {
                        // Bulk Visibility
                        config.visible = bulkVisible.includes(key);
                        
                        // Bulk Alignment Override (Legacy logic, but User Config takes precedence later)
                        // We will actually apply User Config again at the end to ensure it sticks.
                        // But for now, let's respect the specific Bulk alignment requirements if user didn't specify.
                        if (!USER_COLUMN_CONFIG[key] || !USER_COLUMN_CONFIG[key].align) {
                             config.align = getBulkAlignment(key);
                        }
                        
                        // Bulk Width Override (Specifics)
                        if (['No', 'SalesOrderDeliveryCode', 'Sales Document'].includes(key)) config.width = 'auto';
                    } else {
                        // Preview Defaults
                        config.visible = true;
                        config.align = 'text-center';
                        config.width = 'auto';
                    }

                    // FINAL Override: Apply User Config again to ensure width/align are strictly followed
                    if (USER_COLUMN_CONFIG[key]) {
                        if (USER_COLUMN_CONFIG[key].align) config.align = USER_COLUMN_CONFIG[key].align;
                        if (USER_COLUMN_CONFIG[key].width) config.width = USER_COLUMN_CONFIG[key].width;
                    }

                    configs[key] = config;
                });
                return configs;
            };

            const [pageSettings, setPageSettings] = React.useState({
                preview: { columns: initialColumnConfig('preview') },
                bulk: { columns: initialColumnConfig('bulk') }
            });
            
            const [advFilters, setAdvFilters] = React.useState({
                salesOrderDeliveryCode: '',
                salesDocument: '',
                productionOrder: '',
                customerPoReference: '',
                subBrand: '',
                customerCode: '',
                soConfDateFrom: '2024-01-01',
                soConfDateTo: '',
                ignoreBlankCustomerPoRef: false,
                ignoreBlankSoConfDate: false,
                hasSalesDocument: 'all',
                hasPickingList: 'all',
                hasFGReadyQtyA: 'all',
            });
            const [advBulkInput, setAdvBulkInput] = React.useState('');
            const [advBulkColumn, setAdvBulkColumn] = React.useState('SalesOrderDeliveryCode');
            const [advBulkLogic, setAdvBulkLogic] = React.useState('Standard');

            const [stBulkInput, setStBulkInput] = React.useState('');
            const [stBulkColumn, setStBulkColumn] = React.useState('SalesOrderDeliveryCode');
            const [stBulkLogic, setStBulkLogic] = React.useState('Standard');

            const handleFileUpload = React.useCallback(async (file) => {
                setLoading(true);
                try {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const binaryStr = e.target?.result;
                        const workbook = XLSX.read(binaryStr, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        
                        const rows = jsonData.slice(1).map((rowArr) => {
                            const obj = {};
                            COLUMN_KEYS.forEach((key, index) => {
                                let val = rowArr[index];
                                if (val !== undefined && val !== null) {
                                    if (typeof val === 'string') {
                                        val = val.trim();
                                        const numVal = Number(val.replace(/,/g, ''));
                                        if (val !== '' && !isNaN(numVal)) val = numVal;
                                    }
                                } else {
                                    val = null;
                                }
                                obj[key] = val;
                            });
                            return obj;
                        });

                        setData(rows);
                        setMainFilteredData(rows);
                        setStandaloneFilteredData(rows);
                        setIsLoaded(true);
                        setLoading(false);
                    };
                    reader.readAsBinaryString(file);
                } catch (error) {
                    console.error("Error reading file:", error);
                    setLoading(false);
                }
            }, []);

            const activeData = React.useMemo(() => {
                return activeTab === 'bulk' ? standaloneFilteredData : mainFilteredData;
            }, [activeTab, standaloneFilteredData, mainFilteredData]);

            const activeTotals = React.useMemo(() => {
                let transit = 0;
                let approved = 0;
                let pending = 0;
                activeData.forEach(row => {
                    transit += Number(row["FG Transit Qty"] || 0);
                    approved += Number(row["FG Ready Qty (A)"] || 0);
                    pending += Number(row["FG Ready Qty (P)"] || 0);
                });
                return { transit, approved, pending };
            }, [activeData]);

            const extractSOCode = (val) => {
                const match = val.match(/[A-Z]+\d+/i);
                return match ? match[0].toLowerCase() : val.toLowerCase();
            };

            const performFilter = React.useCallback((sourceData, criteria, bulkIn, bulkCol, bulkLog) => {
                const cleanedBulkInputs = bulkIn.split(/[\n,;]/).map(item => item.trim().toLowerCase()).filter(item => item.length > 0);
                return sourceData.filter((row) => {
                    if (criteria) {
                        const matchText = (field, filterVal) => !filterVal || String(row[field] || "").toLowerCase().includes(filterVal.toLowerCase());
                        if (!matchText("SalesOrderDeliveryCode", criteria.salesOrderDeliveryCode)) return false;
                        if (!matchText("Sales Document", criteria.salesDocument)) return false;
                        if (!matchText("Production Order", criteria.productionOrder)) return false;
                        if (!matchText("Customer PO Reference", criteria.customerPoReference)) return false;
                        if (!matchText("Sub Brand", criteria.subBrand)) return false;
                        if (!matchText("Customer Code", criteria.customerCode)) return false;
                        if (criteria.ignoreBlankCustomerPoRef && !row["Customer PO Reference"]) return false;
                        if (criteria.ignoreBlankSoConfDate && !row["SO Conf. Date"]) return false;
                        if (criteria.soConfDateFrom || criteria.soConfDateTo) {
                            const rawDate = row["SO Conf. Date"];
                            if (!rawDate) return false;
                            let rowDate;
                            if (typeof rawDate === 'number') { rowDate = new Date((rawDate - 25569) * 86400 * 1000).getTime(); } 
                            else { rowDate = new Date(String(rawDate)).getTime(); }
                            if (criteria.soConfDateFrom && rowDate < new Date(criteria.soConfDateFrom).getTime()) return false;
                            if (criteria.soConfDateTo && rowDate > new Date(criteria.soConfDateTo).getTime()) return false;
                        }
                        const checkTF = (val, target, logic) => {
                            if (target === 'all') return true;
                            const isTrue = logic ? logic(val) : (val !== null && val !== undefined && String(val).trim() !== "");
                            return target === 'true' ? isTrue : !isTrue;
                        };
                        if (!checkTF(row["Sales Document"], criteria.hasSalesDocument)) return false;
                        if (!checkTF(row["Picking List"], criteria.hasPickingList)) return false;
                        if (!checkTF(row["FG Ready Qty (A)"], criteria.hasFGReadyQtyA, (v) => typeof v === 'number' && v > 0)) return false;
                    }
                    if (cleanedBulkInputs.length > 0) {
                        const columnsToSearch = bulkCol === 'Anything' ? ['SalesOrderDeliveryCode', 'Production Order', 'Sales Document', 'Customer Code', 'Sub Brand', 'Customer PO Reference'] : [bulkCol];
                        return columnsToSearch.some(colName => {
                            const dataValue = String(row[colName] || "").toLowerCase().trim();
                            return cleanedBulkInputs.some(input => {
                                if (bulkLog === 'Standard') return dataValue === input;
                                if (bulkLog === 'LogicA') return dataValue.includes(input);
                                if (bulkLog === 'LogicB' && colName === 'SalesOrderDeliveryCode') {
                                    return extractSOCode(dataValue) === extractSOCode(input) || dataValue.includes(extractSOCode(input));
                                }
                                return dataValue === input;
                            });
                        });
                    }
                    return true;
                });
            }, []);

            const applyAdvancedCombined = React.useCallback(() => {
                const result = performFilter(data, advFilters, advBulkInput, advBulkColumn, advBulkLogic);
                setMainFilteredData(result);
                setActiveTab('preview');
            }, [data, advFilters, advBulkInput, advBulkColumn, advBulkLogic, performFilter]);

            const applyStandaloneBulk = React.useCallback(() => {
                const result = performFilter(data, null, stBulkInput, stBulkColumn, stBulkLogic);
                setStandaloneFilteredData(result);
            }, [data, stBulkInput, stBulkColumn, stBulkLogic, performFilter]);

            const handleClearAdvanced = React.useCallback(() => {
                setAdvFilters({ salesOrderDeliveryCode: '', salesDocument: '', productionOrder: '', customerPoReference: '', subBrand: '', customerCode: '', soConfDateFrom: '2024-01-01', soConfDateTo: '', ignoreBlankCustomerPoRef: false, ignoreBlankSoConfDate: false, hasSalesDocument: 'all', hasPickingList: 'all', hasFGReadyQtyA: 'all' });
                setAdvBulkInput('');
                setMainFilteredData(data);
            }, [data]);

            const handleExport = React.useCallback((rows) => {
                if (rows.length === 0) return;
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "COMTRACK_Export");
                XLSX.writeFile(wb, `COMTRACK_Export_${new Date().toISOString().split('T')[0]}.xlsx`);
            }, []);

            const updateSettings = (page, key, config) => {
                setPageSettings(prev => ({ ...prev, [page]: { ...prev[page], columns: { ...prev[page].columns, [key]: { ...prev[page].columns[key], ...config } } } }));
            };

            const formatHeaderNum = (num) => {
                return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(num);
            };

            const VerticalSeparator = () => <div className="hidden lg:block h-10 w-px bg-slate-200 mx-2"></div>;

            const handleResetApp = () => {
                setData([]);
                setMainFilteredData([]);
                setStandaloneFilteredData([]);
                setInstructionsData([]);
                setInstructionsV2Data([]);
                setIsLoaded(false);
                setActiveTab('preview');
            };

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-[100] px-4 md:px-6 py-3 md:py-4 md:h-[70px] flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm">
                        <div className="flex items-center gap-3 w-full md:w-auto">
                            <div className="bg-blue-600 p-2 rounded-lg text-white">
                                <Icons.Table className="w-5 h-5 md:w-6 md:h-6" />
                            </div>
                            <div>
                                <h1 className="text-lg md:text-xl font-bold text-slate-900 tracking-tight uppercase leading-none">COMTRACK</h1>
                                <p className="text-[9px] md:text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5 md:mt-1">Supply Chain Hub</p>
                            </div>
                        </div>

                        {isLoaded && (
                            <div className="flex flex-col sm:flex-row items-center gap-4 md:gap-8 w-full md:w-auto">
                                <div className="flex items-center justify-between sm:justify-center w-full sm:w-auto overflow-x-auto no-scrollbar py-1">
                                    <div className="text-center px-2 md:px-4 min-w-[60px]">
                                        <p className="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Pool</p>
                                        <p className="text-sm md:text-lg font-bold text-slate-700 leading-none">{data.length.toLocaleString()}</p>
                                    </div>
                                    
                                    <VerticalSeparator />

                                    <div className="text-center px-2 md:px-4 min-w-[80px]">
                                        <p className="text-[9px] text-orange-400 font-bold uppercase tracking-wider mb-0.5 whitespace-nowrap">Transit</p>
                                        <p className="text-sm md:text-lg font-bold text-orange-600 leading-none">{formatHeaderNum(activeTotals.transit)}</p>
                                    </div>

                                    <VerticalSeparator />

                                    <div className="text-center px-2 md:px-4 min-w-[80px]">
                                        <p className="text-[9px] text-green-400 font-bold uppercase tracking-wider mb-0.5 whitespace-nowrap">Ready A</p>
                                        <p className="text-sm md:text-lg font-bold text-green-600 leading-none">{formatHeaderNum(activeTotals.approved)}</p>
                                    </div>

                                    <VerticalSeparator />

                                    <div className="text-center px-2 md:px-4 min-w-[80px]">
                                        <p className="text-[9px] text-red-400 font-bold uppercase tracking-wider mb-0.5 whitespace-nowrap">Ready P</p>
                                        <p className="text-sm md:text-lg font-bold text-red-600 leading-none">{formatHeaderNum(activeTotals.pending)}</p>
                                    </div>

                                    <VerticalSeparator />

                                    <div className="text-center px-2 md:px-4 min-w-[60px]">
                                        <p className="text-[9px] text-blue-400 font-bold uppercase tracking-wider mb-0.5 whitespace-nowrap">Active</p>
                                        <p className="text-sm md:text-lg font-bold text-blue-600 leading-none">{activeData.length.toLocaleString()}</p>
                                    </div>
                                </div>
                                
                                <div className="flex gap-2 w-full sm:w-auto">
                                    <button onClick={() => handleExport(activeData)} className="flex-1 sm:flex-none px-3 md:px-4 py-2 text-[10px] md:text-xs font-bold text-white bg-green-600 hover:bg-green-700 rounded-md transition-all flex items-center justify-center gap-2 shadow-sm uppercase tracking-wide">
                                        <Icons.Download className="w-4 h-4" />
                                        <span className="hidden sm:inline">Download</span>
                                    </button>

                                    <button onClick={handleResetApp} className="flex-1 sm:flex-none px-3 md:px-4 py-2 text-[10px] md:text-xs font-bold text-red-500 hover:text-red-700 hover:bg-red-50 rounded-md transition-all flex items-center justify-center gap-2 uppercase tracking-wide">
                                        <Icons.Upload className="w-4 h-4" />
                                        <span className="hidden sm:inline">Reset</span>
                                    </button>
                                </div>
                            </div>
                        )}
                    </header>

                    {isLoaded && (
                        <nav className="bg-white border-b border-slate-200 px-4 md:px-6 overflow-x-auto custom-scrollbar sticky top-[125px] md:top-[70px] h-[52px] z-[90]">
                            <div className="flex gap-6 md:gap-8 whitespace-nowrap h-full">
                                {[
                                    { id: 'preview', label: 'Dashboard', icon: Icons.Table },
                                    { id: 'instructions', label: 'Instructions', icon: Icons.ClipboardList },
                                    { id: 'instructionsV2', label: 'Instructions-V2', icon: Icons.ClipboardList },
                                    { id: 'advanced', label: 'Advanced Filter', icon: Icons.Filter },
                                    { id: 'bulk', label: 'Bulk Filter', icon: Icons.Search },
                                    { id: 'settings', label: 'Settings', icon: Icons.Search }
                                ].map((tab) => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`h-full text-[10px] md:text-[11px] font-bold uppercase tracking-widest border-b-2 transition-all flex items-center gap-2 ${activeTab === tab.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400 hover:text-slate-800'}`}>
                                        <tab.icon className="w-4 h-4" />
                                        {tab.label}
                                    </button>
                                ))}
                            </div>
                        </nav>
                    )}

                    <main className="flex-1 p-3 md:p-6 max-w-[1700px] mx-auto w-full overflow-x-hidden">
                        {!isLoaded ? (
                            <div className="min-h-[calc(100vh-200px)] flex items-center justify-center p-4">
                                <DataUpload onUpload={handleFileUpload} loading={loading} />
                            </div>
                        ) : (
                            <div className="space-y-4 md:space-y-6">
                                {activeTab === 'instructions' && (
                                    <Instructions 
                                        dataSheet={data} 
                                        instructions={instructionsData} 
                                        setInstructions={setInstructionsData} 
                                    />
                                )}
                                {activeTab === 'instructionsV2' && (
                                    <InstructionsV2
                                        dataSheet={data}
                                        instructions={instructionsV2Data}
                                        setInstructions={setInstructionsV2Data}
                                    />
                                )}
                                {activeTab === 'settings' && <Settings settings={pageSettings} onUpdate={updateSettings} />}
                                {activeTab === 'advanced' && (
                                    <div className="space-y-4 md:space-y-6">
                                        <FilterPanel filters={advFilters} setFilters={setAdvFilters} onApply={applyAdvancedCombined} onClear={handleClearAdvanced} isAdvanced={true} />
                                        <BulkSearch onSearch={applyAdvancedCombined} inputText={advBulkInput} setInputText={setAdvBulkInput} column={advBulkColumn} setColumn={setAdvBulkColumn} logic={advBulkLogic} setLogic={setAdvBulkLogic} />
                                    </div>
                                )}
                                {activeTab === 'bulk' && (
                                    <div className="space-y-4 md:space-y-6">
                                        <BulkSearch onSearch={applyStandaloneBulk} inputText={stBulkInput} setInputText={setStBulkInput} column={stBulkColumn} setColumn={setStBulkColumn} logic={stBulkLogic} setLogic={setStBulkLogic} />
                                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                            <div className="px-4 md:px-6 py-3 border-b border-slate-200 bg-slate-50/50 flex justify-between items-center">
                                                <h2 className="text-[10px] md:text-xs font-bold text-slate-800 uppercase tracking-widest">Bulk Result View</h2>
                                                <span className="text-[9px] md:text-[10px] font-bold text-blue-600 uppercase tracking-widest">{standaloneFilteredData.length} Matches</span>
                                            </div>
                                            <DataTable rows={standaloneFilteredData.slice(0, 500)} columnSettings={pageSettings.bulk.columns} />
                                        </div>
                                    </div>
                                )}
                                {activeTab === 'preview' && (
                                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                        <div className="px-4 md:px-6 py-4 border-b border-slate-200 bg-slate-50/50 flex justify-between items-center">
                                            <h2 className="text-xs md:text-sm font-bold text-slate-800 uppercase tracking-widest">Master Data Preview</h2>
                                            <span className="text-[9px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest">Top 250 records</span>
                                        </div>
                                        <DataTable rows={mainFilteredData.slice(0, 250)} columnSettings={pageSettings.preview.columns} />
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                    
                    <footer className="bg-white border-t border-slate-200 py-4 px-6 text-center">
                        <p className="text-[9px] md:text-[10px] text-slate-400 font-bold uppercase tracking-widest">COMTRACK Supply Chain Intelligence © 2024</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>

